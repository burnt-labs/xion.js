name: Dependency Validation

on:
  pull_request:
    paths:
      - 'packages/**'
      - '.github/workflows/dependency-validation.yml'
  push:
    branches: [main, develop]
    paths:
      - 'packages/**'
      - '.github/workflows/dependency-validation.yml'
  workflow_dispatch:

jobs:
  validate-dependencies:
    name: Validate Package Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run circular dependency tests
        run: pnpm --filter @burnt-labs/signers test src/__tests__/circular-deps.test.ts

      - name: Run AA API type validation tests
        run: pnpm --filter @burnt-labs/signers test src/__tests__/aa-api-types.test.ts

      - name: Check @cosmjs version consistency across packages
        run: |
          echo "ğŸ” Checking @cosmjs version consistency across all packages..."

          # Collect all @cosmjs packages and their versions
          COSMJS_VERSIONS=""
          for pkg_file in packages/*/package.json; do
            versions=$(jq -r '
              [(.dependencies // {}), (.peerDependencies // {})] |
              add |
              to_entries[] |
              select(.key | startswith("@cosmjs/")) |
              "\(.key)=\(.value)"
            ' "$pkg_file" 2>/dev/null)

            if [ -n "$versions" ]; then
              COSMJS_VERSIONS="$COSMJS_VERSIONS$versions"$'\n'
            fi
          done

          # Remove empty lines and sort
          COSMJS_VERSIONS=$(echo "$COSMJS_VERSIONS" | grep -v '^$' | sort -u)

          if [ -z "$COSMJS_VERSIONS" ]; then
            echo "âš ï¸  No @cosmjs dependencies found"
            exit 0
          fi

          # Check each @cosmjs package for version consistency
          echo "$COSMJS_VERSIONS" | cut -d= -f1 | sort -u | while read package; do
            versions=$(echo "$COSMJS_VERSIONS" | grep "^${package}=" | cut -d= -f2 | sort -u)
            version_count=$(echo "$versions" | wc -l | tr -d ' ')

            if [ "$version_count" -gt 1 ]; then
              echo ""
              echo "âŒ Inconsistent versions detected for $package:"
              echo "$versions" | while read version; do
                echo "  Version: $version"
                for pkg_file in packages/*/package.json; do
                  if grep -q "\"$package\": \"$version\"" "$pkg_file"; then
                    echo "    - $pkg_file"
                  fi
                done
              done
              exit 1
            fi
          done

          echo ""
          echo "âœ… All @cosmjs packages use consistent versions across the monorepo:"
          COMMON_VERSION=$(echo "$COSMJS_VERSIONS" | head -1 | cut -d= -f2)
          echo "   Version: $COMMON_VERSION"

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All dependency validation checks passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
