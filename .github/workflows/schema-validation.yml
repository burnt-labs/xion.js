name: OpenAPI Schema Validation

on:
  pull_request:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      aa_api_url:
        description: 'AA API URL to validate against'
        required: false
        type: string
        default: 'https://aa-api.xion-testnet-2.burnt.com'
  schedule:
    - cron: '0 0 * * *'

jobs:
  validate-schema:
    name: Validate Generated Types Against OpenAPI Schema
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Determine AA API URL
        id: config
        run: |
          if [ -n "${{ github.event.inputs.aa_api_url }}" ]; then
            AA_API_URL="${{ github.event.inputs.aa_api_url }}"
          else
            AA_API_URL="https://aa-api.xion-testnet-2.burnt.com"
          fi
          echo "aa_api_url=$AA_API_URL" >> $GITHUB_OUTPUT

      - name: Backup Current Generated Types
        run: cp -r packages/signers/src/types/generated /tmp/generated-backup

      - name: Generate Types from Live AA API
        run: pnpm --filter @burnt-labs/signers exec tsx ../../scripts/generate-aa-api-types.ts "${{ steps.config.outputs.aa_api_url }}"

      - name: Compare Generated Types
        id: compare
        run: |
          SCHEMA_CHANGED=false
          > /tmp/schema-diff.txt

          for ts_file in packages/signers/src/types/generated/*.ts; do
            if [ -f "$ts_file" ]; then
              backup_file="/tmp/generated-backup/$(basename "$ts_file")"
              if [ ! -f "$backup_file" ]; then
                echo "New file detected: $(basename "$ts_file")"
                SCHEMA_CHANGED=true
                {
                  echo "=== NEW FILE: $(basename "$ts_file") ==="
                  head -30 "$ts_file"
                  echo "... (truncated)"
                } >> /tmp/schema-diff.txt
              elif ! diff "$ts_file" "$backup_file" > /tmp/temp-diff.txt 2>&1; then
                echo "Changes detected in: $(basename "$ts_file")"
                SCHEMA_CHANGED=true
                {
                  echo "=== CHANGES IN: $(basename "$ts_file") ==="
                  cat /tmp/temp-diff.txt
                } >> /tmp/schema-diff.txt
              fi
            fi
          done

          for backup_file in /tmp/generated-backup/*.ts; do
            if [ -f "$backup_file" ]; then
              current_file="packages/signers/src/types/generated/$(basename "$backup_file")"
              if [ ! -f "$current_file" ]; then
                echo "File deleted: $(basename "$backup_file")"
                SCHEMA_CHANGED=true
                echo "=== DELETED FILE: $(basename "$backup_file") ===" >> /tmp/schema-diff.txt
              fi
            fi
          done

          echo "schema_changed=$SCHEMA_CHANGED" >> $GITHUB_OUTPUT

          if [ "$SCHEMA_CHANGED" = true ]; then
            echo "Schema drift detected"
            head -50 /tmp/schema-diff.txt
          else
            echo "Generated types match committed types"
          fi

      - name: Upload Diff Artifact
        if: steps.compare.outputs.schema_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: schema-diff
          path: /tmp/schema-diff.txt

      - name: Post Schema Drift Comment
        if: github.event_name == 'pull_request' && steps.compare.outputs.schema_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = '## ⚠️ AA-API Schema Drift\n\n' +
              '**Generated types don\'t match the live schema.**\n\n' +
              '**Action:** Run `pnpm generate:types` in `packages/signers`, review changes, and commit.\n\n' +
              '<details>\n' +
              '<summary>Details</summary>\n\n' +
              '**AA-API URL:** `${{ steps.config.outputs.aa_api_url }}`\n\n' +
              '**Possible causes:**\n' +
              '- AA-API schema changed\n' +
              '- Types are out of sync\n' +
              '- Manual modifications to generated types\n\n' +
              '*Diff available in workflow artifacts.*\n' +
              '</details>';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail on Schema Drift
        if: steps.compare.outputs.schema_changed == 'true'
        run: |
          echo "Schema drift detected - please regenerate types"
          exit 1
