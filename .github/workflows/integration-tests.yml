name: Integration Tests

on:
  pull_request:
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Integration test environment'
        required: false
        type: choice
        options:
          - testnet
          - mainnet
        default: 'testnet'
      aa_api_url:
        description: 'Custom AA API URL to use for integration tests'
        required: false
        type: string
  push:
    branches:
      - main
      - develop

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  integration-test:
    name: Run integration tests (${{ github.event.inputs.test_environment || 'testnet' }})
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install

      - name: Generate AA API Types
        run: pnpm generate:types

      - name: Build
        run: pnpm build

      - name: Load Test Configuration
        id: config
        run: |
          TEST_ENV="${{ github.event.inputs.test_environment || 'testnet' }}"
          echo "test_environment=$TEST_ENV" >> $GITHUB_OUTPUT

          chmod +x .github/scripts/load-test-config.sh
          source .github/scripts/load-test-config.sh "$TEST_ENV"

          if [ -n "${{ github.event.inputs.aa_api_url }}" ]; then
            FINAL_AA_API_URL="${{ github.event.inputs.aa_api_url }}"
          else
            FINAL_AA_API_URL="$XION_AA_API_URL"
          fi

          echo "aa_api_url=$FINAL_AA_API_URL" >> $GITHUB_OUTPUT
          echo "XION_AA_API_URL=$FINAL_AA_API_URL" >> $GITHUB_ENV

      - name: Run Integration Tests
        id: run-tests
        env:
          TEST_ENVIRONMENT: ${{ steps.config.outputs.test_environment }}
          XION_TESTNET_CHAIN_ID: ${{ env.XION_TESTNET_CHAIN_ID }}
          XION_TESTNET_RPC_URL: ${{ env.XION_TESTNET_RPC_URL }}
          XION_TESTNET_REST_URL: ${{ env.XION_TESTNET_REST_URL }}
          XION_TESTNET_GAS_PRICE: ${{ env.XION_TESTNET_GAS_PRICE }}
          XION_TESTNET_FEE_GRANTER: ${{ env.XION_TESTNET_FEE_GRANTER }}
          XION_TESTNET_AA_API_URL: ${{ steps.config.outputs.test_environment == 'testnet' && steps.config.outputs.aa_api_url || env.XION_TESTNET_AA_API_URL }}
          XION_TESTNET_TREASURY_ADDRESS: ${{ env.XION_TESTNET_TREASURY_ADDRESS }}
          XION_TESTNET_INDEXER_URL: ${{ secrets.XION_TESTNET_INDEXER_URL }}
          XION_TESTNET_TREASURY_INDEXER_URL: ${{ secrets.XION_TESTNET_TREASURY_INDEXER_URL }}
          XION_MAINNET_CHAIN_ID: ${{ env.XION_MAINNET_CHAIN_ID }}
          XION_MAINNET_RPC_URL: ${{ env.XION_MAINNET_RPC_URL }}
          XION_MAINNET_REST_URL: ${{ env.XION_MAINNET_REST_URL }}
          XION_MAINNET_GAS_PRICE: ${{ env.XION_MAINNET_GAS_PRICE }}
          XION_MAINNET_FEE_GRANTER: ${{ env.XION_MAINNET_FEE_GRANTER }}
          XION_MAINNET_TREASURY_ADDRESS: ${{ env.XION_MAINNET_TREASURY_ADDRESS }}
          XION_MAINNET_AA_API_URL: ${{ secrets.XION_MAINNET_AA_API_URL }}
          XION_MAINNET_INDEXER_URL: ${{ secrets.XION_MAINNET_INDEXER_URL }}
          XION_MAINNET_TREASURY_INDEXER_URL: ${{ secrets.XION_MAINNET_TREASURY_INDEXER_URL }}
          TEST_TIMEOUT: ${{ env.TEST_TIMEOUT }}
          INTEGRATION_TEST_TIMEOUT: ${{ env.INTEGRATION_TEST_TIMEOUT }}
          NODE_ENV: test
          CI: true
        run: |
          echo "Running integration tests"
          echo "Environment: $TEST_ENVIRONMENT"
          echo "AA-API URL: ${{ steps.config.outputs.aa_api_url }}"

          set +e

          pnpm --filter @burnt-labs/account-management test:integration 2>&1 | tee account-management-results.txt
          ACCOUNT_MGMT_EXIT=$?

          pnpm --filter @burnt-labs/abstraxion test:integration 2>&1 | tee abstraxion-results.txt
          ABSTRAXION_EXIT=$?

          TOTAL_FAILED=0

          if [ -f account-management-results.txt ]; then
            FAILED=$(grep -a 'Tests' account-management-results.txt 2>/dev/null | grep -oP '\d+(?=\s+failed)' | head -1 || echo "0")
            TOTAL_FAILED=$((TOTAL_FAILED + FAILED))
          fi

          if [ -f abstraxion-results.txt ]; then
            FAILED=$(grep -a 'Tests' abstraxion-results.txt 2>/dev/null | grep -oP '\d+(?=\s+failed)' | head -1 || echo "0")
            TOTAL_FAILED=$((TOTAL_FAILED + FAILED))
          fi

          if [ -f account-management-results.txt ]; then
            ACCT_MGMT_SUMMARY=$(grep -a -E "Test Files|Tests.*failed|Tests.*passed|Start at|Duration" account-management-results.txt 2>/dev/null | grep -v "Error:" | tail -4 || echo "No summary available")
            echo "acct_mgmt_summary<<EOF_ACCT" >> $GITHUB_OUTPUT
            echo "$ACCT_MGMT_SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF_ACCT" >> $GITHUB_OUTPUT
          else
            echo "acct_mgmt_summary=No results" >> $GITHUB_OUTPUT
          fi

          if [ -f abstraxion-results.txt ]; then
            ABSTRAXION_SUMMARY=$(grep -a -E "Test Files|Tests.*failed|Tests.*passed|Start at|Duration" abstraxion-results.txt 2>/dev/null | grep -v "Error:" | tail -4 || echo "No summary available")
            echo "abstraxion_summary<<EOF_ABS" >> $GITHUB_OUTPUT
            echo "$ABSTRAXION_SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF_ABS" >> $GITHUB_OUTPUT
          else
            echo "abstraxion_summary=No results" >> $GITHUB_OUTPUT
          fi

          echo "total_failed=$TOTAL_FAILED" >> $GITHUB_OUTPUT

          if [ $TOTAL_FAILED -gt 10 ]; then
            echo "test_status=failed" >> $GITHUB_OUTPUT
            exit 1
          elif [ $TOTAL_FAILED -gt 0 ]; then
            echo "test_status=warning" >> $GITHUB_OUTPUT
          else
            echo "test_status=success" >> $GITHUB_OUTPUT
          fi

          set -e

      - name: Post Test Results Comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const acctMgmtSummary = `${{ steps.run-tests.outputs.acct_mgmt_summary }}`;
            const abstraxionSummary = `${{ steps.run-tests.outputs.abstraxion_summary }}`;
            const totalFailed = parseInt('${{ steps.run-tests.outputs.total_failed }}', 10) || 0;
            const testStatus = '${{ steps.run-tests.outputs.test_status }}' || 'unknown';

            if ((!acctMgmtSummary || acctMgmtSummary.trim() === '') &&
                (!abstraxionSummary || abstraxionSummary.trim() === '')) {
              console.log('No test results available, skipping comment');
              return;
            }

            let testSummaryParts = [];
            if (acctMgmtSummary && acctMgmtSummary !== 'No results') {
              testSummaryParts.push('**@burnt-labs/account-management:**\n```\n' + acctMgmtSummary + '\n```');
            }
            if (abstraxionSummary && abstraxionSummary !== 'No results') {
              testSummaryParts.push('**@burnt-labs/abstraxion:**\n```\n' + abstraxionSummary + '\n```');
            }
            const testSummary = testSummaryParts.join('\n\n');

            let emoji = '✅';
            let statusText = 'All tests passed';

            if (testStatus === 'failed') {
              emoji = '❌';
              statusText = 'Too many failures (' + totalFailed + ' > 10)';
            } else if (testStatus === 'warning') {
              emoji = '⚠️';
              statusText = 'Some tests failed (' + totalFailed + ' ≤ 10)';
            }

            const noteText = totalFailed > 0
              ? '\n\n> **Note:** Some integration test failures are expected due to testnet instability.'
              : '';

            const body = '## ' + emoji + ' Integration Test Results\n\n' +
              '**Status:** ' + statusText + '\n\n' +
              testSummary +
              noteText + '\n\n' +
              '---\n' +
              '*Environment: ${{ steps.config.outputs.test_environment }}* | *AA-API: ${{ steps.config.outputs.aa_api_url }}*';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
