name: üß™ Integration Tests

on:
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Integration test environment'
        required: false
        type: choice
        options:
          - testnet
          - mainnet
        default: 'testnet'
      aa_api_mode:
        description: 'AA API mode'
        required: false
        type: choice
        options:
          - live-url
          - dev-server
        default: 'live-url'
      aa_api_url:
        description: 'Custom AA API URL (only used when aa_api_mode is live-url)'
        required: false
        type: string
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  integration-test:
    name: üß™ Integration Tests (${{ github.event.inputs.test_environment || 'testnet' }})
    strategy:
      matrix:
        os: [ubuntu-latest]
        node-version: [lts/*]
        pnpm-version: [8.9.0]
    runs-on: ${{ matrix.os }}
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: ü•° Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ matrix.pnpm-version }}

      - name: üîÑ Install Dependencies
        run: pnpm install

      - name: üèóÔ∏è Build
        run: pnpm build

      - name: üìù Load Test Configuration
        id: config
        run: |
          # Install jq if not available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          TEST_ENV="${{ github.event.inputs.test_environment || 'testnet' }}"
          AA_API_MODE="${{ github.event.inputs.aa_api_mode || 'live-url' }}"

          echo "test_environment=$TEST_ENV" >> $GITHUB_OUTPUT
          echo "aa_api_mode=$AA_API_MODE" >> $GITHUB_OUTPUT

          # Load configuration from JSON file
          chmod +x .github/scripts/load-test-config.sh
          source .github/scripts/load-test-config.sh "$TEST_ENV"

          # Override AA-API URL if specified
          if [ "$AA_API_MODE" == "dev-server" ]; then
            FINAL_AA_API_URL="http://localhost:8787"
            echo "Using AA-API dev server: $FINAL_AA_API_URL"
          elif [ -n "${{ github.event.inputs.aa_api_url }}" ]; then
            FINAL_AA_API_URL="${{ github.event.inputs.aa_api_url }}"
            echo "Using custom AA-API URL: $FINAL_AA_API_URL"
          else
            FINAL_AA_API_URL="$XION_AA_API_URL"
            echo "Using configured AA-API URL: $FINAL_AA_API_URL"
          fi

          echo "aa_api_url=$FINAL_AA_API_URL" >> $GITHUB_OUTPUT
          echo "XION_AA_API_URL=$FINAL_AA_API_URL" >> $GITHUB_ENV

      - name: üöÄ Start AA API Dev Server (if needed)
        id: start-aa-api
        if: steps.config.outputs.aa_api_mode == 'dev-server'
        run: |
          # Navigate to account-abstraction-api directory
          cd ../account-abstraction-api || cd ../../account-abstraction-api || (echo "‚ùå account-abstraction-api directory not found" && exit 1)

          echo "Starting AA API dev server..."
          npm run dev > /tmp/aa-api.log 2>&1 &
          AA_API_PID=$!
          echo "pid=$AA_API_PID" >> $GITHUB_OUTPUT

          # Wait for server to be ready (health check)
          echo "Waiting for AA API to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:8787/healthz > /dev/null 2>&1; then
              echo "‚úÖ AA API is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå AA API failed to start"
              cat /tmp/aa-api.log
              exit 1
            fi
            sleep 2
          done

          echo "AA API started successfully on http://localhost:8787"
        env:
          # Sensitive values from GitHub secrets (required for dev-server mode)
          STYTCH_PROJECT_ID: ${{ secrets.STYTCH_PROJECT_ID }}
          STYTCH_SECRET: ${{ secrets.STYTCH_SECRET }}

          # Public defaults from config file (already loaded)
          FEE_GRANTER_ADDRESS: ${{ env.XION_FEE_GRANTER }}
          STYTCH_API_URL: ${{ env.AA_API_STYTCH_API_URL }}
          CHECKSUM: ${{ env.AA_API_CHECKSUM }}
          CODE_ID: ${{ env.AA_API_CODE_ID }}
          ADDRESS_PREFIX: ${{ env.XION_ADDRESS_PREFIX }}
          GAS_PRICE: ${{ env.XION_GAS_PRICE }}
          GAS_ADJUSTMENT: ${{ env.XION_GAS_ADJUSTMENT }}
          XION_RPC_URL: ${{ env.XION_RPC_URL }}
          NODE_ENV: test

      - name: üß™ Run Integration Tests
        env:
          # Test environment from config file
          TEST_ENVIRONMENT: ${{ steps.config.outputs.test_environment }}

          # Testnet configuration (loaded from test-environments.json)
          XION_TESTNET_CHAIN_ID: ${{ env.XION_TESTNET_CHAIN_ID }}
          XION_TESTNET_RPC_URL: ${{ env.XION_TESTNET_RPC_URL }}
          XION_TESTNET_REST_URL: ${{ env.XION_TESTNET_REST_URL }}
          XION_TESTNET_GAS_PRICE: ${{ env.XION_TESTNET_GAS_PRICE }}
          XION_TESTNET_FEE_GRANTER: ${{ env.XION_TESTNET_FEE_GRANTER }}
          XION_TESTNET_AA_API_URL: ${{ steps.config.outputs.test_environment == 'testnet' && steps.config.outputs.aa_api_url || env.XION_TESTNET_AA_API_URL }}
          XION_TESTNET_TREASURY_ADDRESS: ${{ env.XION_TESTNET_TREASURY_ADDRESS }}
          XION_TESTNET_INDEXER_URL: ${{ secrets.XION_TESTNET_INDEXER_URL }}
          XION_TESTNET_TREASURY_INDEXER_URL: ${{ secrets.XION_TESTNET_TREASURY_INDEXER_URL }}

          # Mainnet configuration (loaded from test-environments.json, sensitive URLs from secrets)
          XION_MAINNET_CHAIN_ID: ${{ env.XION_MAINNET_CHAIN_ID }}
          XION_MAINNET_RPC_URL: ${{ env.XION_MAINNET_RPC_URL }}
          XION_MAINNET_REST_URL: ${{ env.XION_MAINNET_REST_URL }}
          XION_MAINNET_GAS_PRICE: ${{ env.XION_MAINNET_GAS_PRICE }}
          XION_MAINNET_FEE_GRANTER: ${{ env.XION_MAINNET_FEE_GRANTER }}
          XION_MAINNET_TREASURY_ADDRESS: ${{ env.XION_MAINNET_TREASURY_ADDRESS }}
          XION_MAINNET_AA_API_URL: ${{ secrets.XION_MAINNET_AA_API_URL }}
          XION_MAINNET_INDEXER_URL: ${{ secrets.XION_MAINNET_INDEXER_URL }}
          XION_MAINNET_TREASURY_INDEXER_URL: ${{ secrets.XION_MAINNET_TREASURY_INDEXER_URL }}

          # Test configuration
          TEST_TIMEOUT: ${{ env.TEST_TIMEOUT }}
          INTEGRATION_TEST_TIMEOUT: ${{ env.INTEGRATION_TEST_TIMEOUT }}
          NODE_ENV: test
          CI: true
        run: |
          echo "üß™ Running integration tests"
          echo "Environment: $TEST_ENVIRONMENT"
          echo "AA-API URL: ${{ steps.config.outputs.aa_api_url }}"
          echo "Chain ID: $XION_TESTNET_CHAIN_ID"
          echo "RPC URL: $XION_TESTNET_RPC_URL"
          echo ""

          # Run integration tests
          pnpm --filter @burnt-labs/account-management test:integration || true
          pnpm --filter @burnt-labs/abstraxion test:integration || true

      - name: üõë Stop AA API Dev Server
        if: always() && steps.start-aa-api.outputs.pid != ''
        run: |
          if [ -n "${{ steps.start-aa-api.outputs.pid }}" ]; then
            echo "Stopping AA API dev server (PID: ${{ steps.start-aa-api.outputs.pid }})"
            kill ${{ steps.start-aa-api.outputs.pid }} || true
            sleep 2
          fi
