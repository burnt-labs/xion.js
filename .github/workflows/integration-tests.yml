name: Integration Tests

on:
  pull_request:
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Integration test environment'
        required: false
        type: choice
        options:
          - testnet
          - mainnet
        default: 'testnet'
      aa_api_url:
        description: 'Custom AA API URL to use for integration tests'
        required: false
        type: string
  push:
    branches:
      - main
      - develop

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  integration-test:
    name: Run integration tests (${{ github.event.inputs.test_environment || 'testnet' }})
    strategy:
      matrix:
        os: [ubuntu-latest]
        node-version: [lts/*]
        pnpm-version: [8.9.0]
    runs-on: ${{ matrix.os }}
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: ü•° Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ matrix.pnpm-version }}

      - name: üîÑ Install Dependencies
        run: pnpm install

      - name: üî® Generate AA API Types
        run: pnpm generate:types

      - name: üèóÔ∏è Build
        run: pnpm build

      - name: üìù Load Test Configuration
        id: config
        run: |
          # Install jq if not available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          TEST_ENV="${{ github.event.inputs.test_environment || 'testnet' }}"

          echo "test_environment=$TEST_ENV" >> $GITHUB_OUTPUT

          # Load configuration from JSON file
          chmod +x .github/scripts/load-test-config.sh
          source .github/scripts/load-test-config.sh "$TEST_ENV"

          # Override AA-API URL if specified
          if [ -n "${{ github.event.inputs.aa_api_url }}" ]; then
            FINAL_AA_API_URL="${{ github.event.inputs.aa_api_url }}"
            echo "Using custom AA-API URL: $FINAL_AA_API_URL"
          else
            FINAL_AA_API_URL="$XION_AA_API_URL"
            echo "Using configured AA-API URL: $FINAL_AA_API_URL"
          fi

          echo "aa_api_url=$FINAL_AA_API_URL" >> $GITHUB_OUTPUT
          echo "XION_AA_API_URL=$FINAL_AA_API_URL" >> $GITHUB_ENV

      - name: üß™ Run Integration Tests
        id: run-tests
        env:
          # Test environment from config file
          TEST_ENVIRONMENT: ${{ steps.config.outputs.test_environment }}

          # Testnet configuration (loaded from test-environments.json)
          XION_TESTNET_CHAIN_ID: ${{ env.XION_TESTNET_CHAIN_ID }}
          XION_TESTNET_RPC_URL: ${{ env.XION_TESTNET_RPC_URL }}
          XION_TESTNET_REST_URL: ${{ env.XION_TESTNET_REST_URL }}
          XION_TESTNET_GAS_PRICE: ${{ env.XION_TESTNET_GAS_PRICE }}
          XION_TESTNET_FEE_GRANTER: ${{ env.XION_TESTNET_FEE_GRANTER }}
          XION_TESTNET_AA_API_URL: ${{ steps.config.outputs.test_environment == 'testnet' && steps.config.outputs.aa_api_url || env.XION_TESTNET_AA_API_URL }}
          XION_TESTNET_TREASURY_ADDRESS: ${{ env.XION_TESTNET_TREASURY_ADDRESS }}
          XION_TESTNET_INDEXER_URL: ${{ secrets.XION_TESTNET_INDEXER_URL }}
          XION_TESTNET_TREASURY_INDEXER_URL: ${{ secrets.XION_TESTNET_TREASURY_INDEXER_URL }}

          # Mainnet configuration (loaded from test-environments.json, sensitive URLs from secrets)
          XION_MAINNET_CHAIN_ID: ${{ env.XION_MAINNET_CHAIN_ID }}
          XION_MAINNET_RPC_URL: ${{ env.XION_MAINNET_RPC_URL }}
          XION_MAINNET_REST_URL: ${{ env.XION_MAINNET_REST_URL }}
          XION_MAINNET_GAS_PRICE: ${{ env.XION_MAINNET_GAS_PRICE }}
          XION_MAINNET_FEE_GRANTER: ${{ env.XION_MAINNET_FEE_GRANTER }}
          XION_MAINNET_TREASURY_ADDRESS: ${{ env.XION_MAINNET_TREASURY_ADDRESS }}
          XION_MAINNET_AA_API_URL: ${{ secrets.XION_MAINNET_AA_API_URL }}
          XION_MAINNET_INDEXER_URL: ${{ secrets.XION_MAINNET_INDEXER_URL }}
          XION_MAINNET_TREASURY_INDEXER_URL: ${{ secrets.XION_MAINNET_TREASURY_INDEXER_URL }}

          # Test configuration
          TEST_TIMEOUT: ${{ env.TEST_TIMEOUT }}
          INTEGRATION_TEST_TIMEOUT: ${{ env.INTEGRATION_TEST_TIMEOUT }}
          NODE_ENV: test
          CI: true
        run: |
          echo "üß™ Running integration tests"
          echo "Environment: $TEST_ENVIRONMENT"
          echo "AA-API URL: ${{ steps.config.outputs.aa_api_url }}"
          echo "Chain ID: $XION_TESTNET_CHAIN_ID"
          echo "RPC URL: $XION_TESTNET_RPC_URL"
          echo ""

          # Run integration tests and capture results
          set +e  # Don't exit on error

          pnpm --filter @burnt-labs/account-management test:integration 2>&1 | tee account-management-results.txt
          ACCOUNT_MGMT_EXIT=$?

          pnpm --filter @burnt-labs/abstraxion test:integration 2>&1 | tee abstraxion-results.txt
          ABSTRAXION_EXIT=$?

          # Parse test results to count failures
          TOTAL_FAILED=0
          TOTAL_PASSED=0

          # Function to extract test counts from vitest output
          # Vitest formats: "Test Files  X failed | Y passed" or "Tests  X failed | Y passed"
          extract_counts() {
            local file=$1

            # Initialize with defaults
            local failed=0
            local passed=0

            # Try pattern 1: "Test Files  X failed | Y passed (Z)"
            local temp_failed=$(grep -oP 'Test Files\s+\K\d+(?=\s+failed)' "$file" 2>/dev/null | head -1 || echo "")
            local temp_passed=$(grep -oP 'Test Files\s+\d+\s+failed \| \K\d+(?=\s+passed)' "$file" 2>/dev/null | head -1 || echo "")

            # Try pattern 2: "Tests  X failed | Y passed"
            if [ -z "$temp_failed" ]; then
              temp_failed=$(grep -oP 'Tests\s+\K\d+(?=\s+failed)' "$file" 2>/dev/null | head -1 || echo "")
            fi
            if [ -z "$temp_passed" ]; then
              temp_passed=$(grep -oP 'Tests\s+\d+\s+failed \| \K\d+(?=\s+passed)' "$file" 2>/dev/null | head -1 || echo "")
            fi

            # Try pattern 3: Just "X passed" (no failures)
            if [ -z "$temp_passed" ]; then
              temp_passed=$(grep -oP 'Tests\s+\K\d+(?=\s+passed)' "$file" 2>/dev/null | head -1 || echo "")
            fi

            # Try pattern 4: "Test Files  X passed" (no failures)
            if [ -z "$temp_passed" ]; then
              temp_passed=$(grep -oP 'Test Files\s+\K\d+(?=\s+passed)' "$file" 2>/dev/null | head -1 || echo "")
            fi

            # Assign only if not empty
            [ -n "$temp_failed" ] && failed=$temp_failed
            [ -n "$temp_passed" ] && passed=$temp_passed

            echo "$failed $passed"
          }

          if [ -f account-management-results.txt ]; then
            echo "=== Parsing account-management results ==="
            grep -i "test" account-management-results.txt | grep -E "(passed|failed)" | head -5
            read FAILED PASSED <<< $(extract_counts account-management-results.txt)
            # Ensure values are numeric
            FAILED=${FAILED:-0}
            PASSED=${PASSED:-0}
            echo "Account Management: $PASSED passed, $FAILED failed"
            TOTAL_FAILED=$((TOTAL_FAILED + FAILED))
            TOTAL_PASSED=$((TOTAL_PASSED + PASSED))
          fi

          if [ -f abstraxion-results.txt ]; then
            echo "=== Parsing abstraxion results ==="
            grep -i "test" abstraxion-results.txt | grep -E "(passed|failed)" | head -5
            read FAILED PASSED <<< $(extract_counts abstraxion-results.txt)
            # Ensure values are numeric
            FAILED=${FAILED:-0}
            PASSED=${PASSED:-0}
            echo "Abstraxion: $PASSED passed, $FAILED failed"
            TOTAL_FAILED=$((TOTAL_FAILED + FAILED))
            TOTAL_PASSED=$((TOTAL_PASSED + PASSED))
          fi

          # Ensure outputs have valid numeric values
          TOTAL_FAILED=${TOTAL_FAILED:-0}
          TOTAL_PASSED=${TOTAL_PASSED:-0}

          echo "total_failed=$TOTAL_FAILED" >> $GITHUB_OUTPUT
          echo "total_passed=$TOTAL_PASSED" >> $GITHUB_OUTPUT

          echo ""
          echo "üìä Test Summary:"
          echo "  Total Passed: $TOTAL_PASSED"
          echo "  Total Failed: $TOTAL_FAILED"

          # Fail if more than 10 tests failed
          if [ $TOTAL_FAILED -gt 10 ]; then
            echo "‚ùå More than 10 tests failed ($TOTAL_FAILED), marking workflow as failed"
            echo "test_status=failed" >> $GITHUB_OUTPUT
            exit 1
          elif [ $TOTAL_FAILED -gt 0 ]; then
            echo "‚ö†Ô∏è  Some tests failed ($TOTAL_FAILED), but within acceptable threshold (‚â§10)"
            echo "test_status=warning" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ All tests passed!"
            echo "test_status=success" >> $GITHUB_OUTPUT
          fi

          set -e

      - name: üí¨ Post Test Results Comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const totalPassed = '${{ steps.run-tests.outputs.total_passed }}' || '0';
            const totalFailed = '${{ steps.run-tests.outputs.total_failed }}' || '0';
            const testStatus = '${{ steps.run-tests.outputs.test_status }}' || 'unknown';

            // Additional safety check for empty strings
            const passed = totalPassed.trim() === '' ? '0' : totalPassed;
            const failed = totalFailed.trim() === '' ? '0' : totalFailed;

            let emoji = '‚úÖ';
            let statusText = 'All tests passed';

            if (testStatus === 'failed') {
              emoji = '‚ùå';
              statusText = 'Too many failures (>10)';
            } else if (testStatus === 'warning') {
              emoji = '‚ö†Ô∏è';
              statusText = 'Some tests failed (‚â§10)';
            }

            const failedCount = parseInt(failed, 10) || 0;
            const passedCount = parseInt(passed, 10) || 0;

            const noteText = failedCount > 0
              ? '\n\n> **Note:** Some integration test failures are expected due to testnet instability (network issues, indexer delays, fee grant limits, etc.).\n> The workflow only fails if more than 10 tests fail.\n'
              : '';

            const body = `## ${emoji} Integration Test Results\n\n**Status:** ${statusText}\n\n- ‚úÖ Passed: ${passed}\n- ‚ùå Failed: ${failed}${noteText}\n---\n*Environment: ${{ steps.config.outputs.test_environment }}*\n*AA-API: ${{ steps.config.outputs.aa_api_url }}*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
